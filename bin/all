#!/bin/bash

src="$1"
dst="$2"
if [ "$dst" = "" ] ; then 
	echo "Usage: all input_dir output_dir"
	exit 1
fi


if cd "$dst" ; then

	# just checking that $dst exists ...
	dst=`pwd -P`
	cd ..

	if cd "$src" ; then

		src=`pwd -P`
		cd ..

		echo "======= Processing $src ..."

		flat="$dst/flat"
		if test -d "$flat" ; then
			rm -r "$flat" 
		fi
		mkdir -p "$flat"

		assembled="$dst/assembled"
		if test -d "$assembled" ; then
			rm -r "$assembled" 
		fi
		mkdir -p "$assembled"

		genos="$dst/genos"
		if test -d "$genos" ; then
			rm -r "$genos" 
		fi
		mkdir -p "$genos"


if false ; then
		echo "======= Flattening and uncompressing ..."
		o=""
		find "$src" | grep .fastq.gz | while read i ; do
			o=`basename "$i"`
			echo $o ...
			cp -i "$i" "$flat/$o"
			chmod u+w "$flat/$o"
			gunzip "$flat/$o"
		done
		if [ "$o" = "" ] ; then
			echo "No source files"
			exit 1
		fi
fi


if false ; then
			echo "======= Merging $flat R1 R2 ..."
			merge_files_in_one_dir.sh "$flat" R1 R2
			find "$dst" | grep assembled.fastq | while read i ; do
				mv "$i" "$assembled"
			done
fi


if false ; then
			echo "======= Making genos files ..."
			pushd "$assembled"
			genotyper "/Volumes/joe/science/bin/LocusInfo.csv"
			mv *.genos ../genos/
			popd
fi



		echo "======= Compiling genos files ..."
		pushd "$genos"
		GTseq_GenoCompile_v2_IFI.pl > "$dst/compiled.csv";
		popd


	fi
fi


