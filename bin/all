#!/bin/bash

src="$1"
dst="$2"
if [ "$dst" = "" ] ; then 
	echo "Usage: all input_dir output_dir"
	exit 1
fi


if cd "$dst" ; then

	# just checking that $dst exists ...
	dst=`pwd -P`
	cd ..

	if cd "$src" ; then

		src=`pwd -P`
		cd ..

		echo "======= Processing $src ..."


		echo "======= Clearing output dir $dst ..."
		rm -r "$dst"/* 

		echo "======= Flattening and uncompressing ..."
		o=""
		find "$src" | grep .fastq.gz | while read i ; do
			o=`basename "$i"`
			echo $o ...
			cp -i "$i" "$dst/$o"
			chmod u+w "$dst/$o"
			gunzip "$dst/$o"
		done

		echo "======= Hashing and counting ..."
		for i in "$dst"/*.fastq ; do
			echo $i
			bin/GTseq_HashSeqs.pl "$i" > "$i.hash"
			bin/GTseq_SeqTest.pl "bin/AssayInfo.txt" "$i.hash" > "$i.csv"
		done

		echo "======= Merging $flat R1 R2 ..."
		bin/merge_files_in_one_dir.sh "$dst" R1 R2 "$dst"
		mv "$dst"/merged_*/*assembled.fastq $dst
		cd $dst
		bin/genotyper "bin/Ots_GTseq95_ProbeSeqs_v2.csv"
		bin/GTseq_GenoCompile_v2_IFI.pl > "$dst/compiled.csv";
		bin/GTseq_GenoCompile_v2_IFI.pl C > "$dst/compiled_counts.csv";
		bin/GTseq_GenoCompile_v2_IFI.pl S > "$dst/compiled_snps.csv";
		bin/GTseq_GenoCompile_v2_IFI.pl N 90 > "$dst/compiled_numeric.csv";

	fi
fi

